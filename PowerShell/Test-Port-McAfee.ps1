[String]$IPs = "10.11.92.197,
10.111.17.130,
10.111.17.144,
10.120.51.246,
10.13.64.11,
10.13.64.19,
10.151.65.5,
10.151.65.8,
10.154.232.31,
10.154.232.32,
10.16.36.13,
10.16.36.14,
10.16.61.95,
10.16.71.6,
10.161.100.73,
10.161.138.68,
10.161.65.10,
10.161.65.11,
10.161.66.38,
10.161.66.44,
10.161.69.132,
10.19.100.133,
10.19.100.68,
10.19.140.25,
10.19.140.9,
10.20.28.10,
10.20.28.11,
10.21.0.39,
10.21.0.40,
10.21.100.132,
10.21.100.135,
10.21.11.69,
10.21.11.71,
10.21.114.132,
10.21.114.134,
10.21.119.228,
10.21.119.244,
10.21.119.5,
10.21.119.6,
10.21.14.196,
10.21.14.197,
10.21.14.21,
10.21.14.36,
10.21.2.36,
10.21.228.100,
10.21.228.101,
10.21.228.38,
10.21.228.39,
10.21.71.52,
10.21.72.132,
10.21.72.133,
10.21.97.100,
10.21.97.101,
10.3.28.12,
10.3.28.25,
10.4.28.34,
10.4.28.35,
10.41.120.4,
10.41.222.4,
10.46.32.145,
10.46.32.151,
10.46.32.221,
10.46.34.187,
10.46.64.51,
10.46.96.79,
10.46.96.92,
10.49.36.76,
10.5.28.11,
10.6.209.13,
10.6.226.12,
10.6.226.8,
10.6.227.126,
10.6.227.47,
10.6.230.120,
10.6.230.59,
10.6.230.79,
10.6.234.23,
10.6.236.66,
10.6.236.71,
10.6.249.201,
10.6.249.202,
10.6.28.10,
10.6.28.16,
10.6.30.114,
10.6.30.115,
10.62.3.15,
10.7.28.10,
10.8.28.14,
10.8.28.15,
10.82.27.132,
10.95.130.25,"

function Test-TCPConnection {
    param
    (
        [parameter(Mandatory = $true)]
        [String]$ips,
        [String]$ports
    )
    $Result = @()
    foreach ($ip in $ips.Split(",")) {
        foreach ($port in $ports.Split(",")) {
            $TCPCon = New-Object System.Net.Sockets.TcpClient
            $ErrorActionPreference = 'SilentlyContinue'
            $connect = $TCPCon.BeginConnect($ip, $port, $null, $null)
            $wait = $connect.AsyncWaitHandle.WaitOne(5000, $false)
            if (-not $wait) {
                $Result += "$ip;$port;BLOCKED."
            } else {
                if ($TCPCon.Connected) {
                    $Result += "$ip;$port;OPEN."
                    $TCPCon.EndConnect($connect)
                } else {
                    $Result += "$ip;$port;BLOCKED."
                }
            }
            $TCPCon.Dispose | Out-Null
            $TCPCon = $null | Out-Null
        }
    }
    $Result >> c:\temp\portcheck.txt
    Return $Result
}

Test-TCPConnection -ips $IPs -ports "8081,8082"


### Agent reaktivieren
cmd.exe /c "%ProgramFiles%\McAfee\Agent\CmdAgent.exe /c"
